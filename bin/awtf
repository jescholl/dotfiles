#!/usr/bin/env python

import ipaddress
import urllib.request
import json
import argparse


def ip_address(string):
    try:
        ip = ipaddress.ip_address(string)
    except ValueError:
        raise argparse.ArgumentTypeError("%r is not a valid IP address" % string)
    return ip

parser = argparse.ArgumentParser(description="Look up AWS IP addresses to determine their region, and service")
parser.add_argument('ip', metavar="IP", type=ip_address, help="IP address to look up")

args = parser.parse_args()

result = json.loads(urllib.request.urlopen("https://ip-ranges.amazonaws.com/ip-ranges.json").read())


table_format_str = "{:<15} {:<15} {:<15}\n"
table = table_format_str.format("Prefix", "Region", "Service")

for prefix in result['prefixes']:
    if args.ip in ipaddress.ip_network(prefix['ip_prefix']):
        table +=  table_format_str.format(prefix['ip_prefix'], prefix['region'], prefix['service'])

print(table)
